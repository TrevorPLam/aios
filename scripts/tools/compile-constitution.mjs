#!/usr/bin/env node

/**
 * Constitution Compiler
 *
 * Reads docs/governance/constitution.md and extracts tagged sections
 * to generate Copilot instruction files.
 *
 * Tagged sections use markers:
 * - ## COPILOT:GLOBAL ‚Üí .github/copilot-instructions.md
 * - ## COPILOT:DOCS ‚Üí .github/instructions/docs.instructions.md
 * - ## COPILOT:CLIENT ‚Üí .github/instructions/client.instructions.md
 * - ## COPILOT:SERVER ‚Üí .github/instructions/server.instructions.md
 *
 * Generated files include a header indicating they are auto-generated.
 */

import { readFileSync, writeFileSync, existsSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const REPO_ROOT = join(__dirname, "../..");
const CONSTITUTION_PATH = join(REPO_ROOT, ".repo/policy/CONSTITUTION.md");
const OUTPUT_DIR = join(REPO_ROOT, ".github");

const TARGETS = {
  "COPILOT:GLOBAL": {
    path: join(OUTPUT_DIR, "copilot-instructions.md"),
    name: "Global Copilot Instructions",
  },
  "COPILOT:DOCS": {
    path: join(OUTPUT_DIR, "instructions/docs.instructions.md"),
    name: "Documentation Path Instructions",
  },
  "COPILOT:CLIENT": {
    path: join(OUTPUT_DIR, "instructions/client.instructions.md"),
    name: "Client/Frontend Path Instructions",
  },
  "COPILOT:SERVER": {
    path: join(OUTPUT_DIR, "instructions/server.instructions.md"),
    name: "Server/Backend Path Instructions",
  },
};

function generateHeader(targetName) {
  const timestamp = new Date().toISOString().split("T")[0];
  return `<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->
<!-- Source: .repo/policy/CONSTITUTION.md -->
<!-- Generated: ${timestamp} -->
<!-- To update: edit constitution.md and run \`npm run compile:constitution\` -->

# ${targetName}

**‚ö†Ô∏è This file is AUTO-GENERATED from the constitution.**

**To make changes:**
1. Edit \`.repo/policy/CONSTITUTION.md\`
2. Run \`npm run compile:constitution\`
3. Commit both files together

**Do NOT edit this file directly** - your changes will be overwritten.

---

`;
}

function extractSections(constitutionContent) {
  const sections = {
    "COPILOT:GLOBAL": [],
    "COPILOT:DOCS": [],
    "COPILOT:CLIENT": [],
    "COPILOT:SERVER": [],
  };

  const lines = constitutionContent.split("\n");
  let currentSection = null;
  let sectionContent = [];

  for (const line of lines) {
    // Check if this line is a section marker
    const markerMatch = line.match(/^##\s+(COPILOT:\w+)/);

    if (markerMatch) {
      // Save previous section if any
      if (currentSection && sectionContent.length > 0) {
        sections[currentSection].push(...sectionContent);
      }

      // Start new section
      currentSection = markerMatch[1];
      sectionContent = [];
    } else if (currentSection) {
      // We're inside a tagged section
      // Check if we've hit another ## heading that's not a COPILOT marker
      // End section only if we hit ## followed by something other than COPILOT:
      if (line.match(/^##\s+(?!COPILOT:)/)) {
        // End of current section (found a non-COPILOT ## heading)
        sections[currentSection].push(...sectionContent);
        currentSection = null;
        sectionContent = [];
      } else {
        // Add line to current section
        sectionContent.push(line);
      }
    }
  }

  // Save last section if any
  if (currentSection && sectionContent.length > 0) {
    sections[currentSection].push(...sectionContent);
  }

  return sections;
}

function generateFooter() {
  return `

---

**Source:** \`.repo/policy/CONSTITUTION.md\`  
**Compiler:** \`scripts/tools/compile-constitution.mjs\`  
**Last Generated:** ${new Date().toISOString()}
`;
}

function compileConstitution() {
  console.log("üìú Constitution Compiler");
  console.log("========================\n");

  // Check if constitution exists
  if (!existsSync(CONSTITUTION_PATH)) {
    console.error(`‚ùå Constitution not found at: ${CONSTITUTION_PATH}`);
    process.exit(1);
  }

  // Read constitution
  console.log(`üìñ Reading constitution from: ${CONSTITUTION_PATH}`);
  const constitutionContent = readFileSync(CONSTITUTION_PATH, "utf-8");

  // Extract tagged sections
  console.log("üîç Extracting tagged sections...");
  const sections = extractSections(constitutionContent);

  let generatedCount = 0;
  let emptyCount = 0;

  // Generate each target file
  for (const [tag, target] of Object.entries(TARGETS)) {
    const sectionContent = sections[tag];

    if (sectionContent.length === 0) {
      console.warn(`‚ö†Ô∏è  No content found for ${tag} - skipping ${target.name}`);
      emptyCount++;
      continue;
    }

    const header = generateHeader(target.name);
    const footer = generateFooter();
    const content = header + sectionContent.join("\n") + footer;

    // Write file
    writeFileSync(target.path, content, "utf-8");
    console.log(`‚úÖ Generated: ${target.path}`);
    generatedCount++;
  }

  console.log("\nüìä Summary:");
  console.log(`   Generated: ${generatedCount} files`);
  console.log(`   Skipped: ${emptyCount} files (no content)`);

  if (generatedCount === 0) {
    console.error(
      "\n‚ùå No files were generated. Check your constitution.md for COPILOT: tags.",
    );
    process.exit(1);
  }

  console.log("\n‚ú® Constitution compiled successfully!");
  console.log("\nüìù Next steps:");
  console.log("   1. Review generated files");
    console.log("   2. Commit changes: git add .github/ .repo/policy/");
  console.log("   3. Push to repository");
}

// Run compiler
try {
  compileConstitution();
} catch (error) {
  console.error("\n‚ùå Error compiling constitution:");
  console.error(error.message);
  console.error(error.stack);
  process.exit(1);
}
