#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push validation checks
echo "ğŸš€ Running pre-push checks..."

# Check if node_modules exists (for AI environments that may not have dependencies)
if [ ! -d "node_modules" ]; then
  echo "âš ï¸  node_modules not found. Skipping pre-push hooks."
  echo "   Run 'npm install' to enable hooks, or use --no-verify to skip."
  echo "   Continuing with push..."
  exit 0
fi

# Check for uncommitted generated files
echo "ğŸ“ Checking for uncommitted generated files..."
if [ -n "$(git status --porcelain INDEX.toon apps/INDEX.toon apps/*/INDEX.toon .github/copilot-instructions.md .github/AGENTS.toon .github/instructions/*.AGENTS.toon 2>/dev/null)" ]; then
  echo "âš ï¸  Warning: Uncommitted generated files detected. Consider committing them."
  echo "   Run: git add INDEX.toon apps/INDEX.toon apps/*/INDEX.toon .github/copilot-instructions.md .github/AGENTS.toon .github/instructions/*.AGENTS.toon"
  echo "   Or push with --no-verify to skip this check"
  # In non-interactive mode, just warn but don't block
  if [ -t 0 ]; then
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      exit 1
    fi
  else
    echo "   (Non-interactive mode: continuing with warning)"
  fi
fi

# Run tests (quick check - full test suite should be in CI)
echo "ğŸ§ª Running quick test check..."
npm test -- --passWithNoTests --maxWorkers=2 || {
  echo "âŒ Tests failed or jest not available."
  echo "   Install dependencies with 'npm install' if tools are missing."
  echo "   Fix test failures before pushing."
  exit 1
}

# Check for secrets in staged files (if gitleaks is available)
if command -v gitleaks >/dev/null 2>&1; then
  echo "ğŸ” Running Gitleaks secret scan on staged files..."
  gitleaks detect --source . --no-banner --verbose --staged || exit 1
fi

# Check governance (lightweight check - full check in CI)
echo "ğŸ“‹ Running governance check..."
npm run check:governance || {
  echo "âš ï¸  Governance check failed. Review and fix issues before pushing."
  exit 1
}

echo "âœ… Pre-push checks passed!"
