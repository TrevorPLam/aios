#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Post-commit automation
echo "ğŸ“Š Running post-commit tasks..."

# Check if node_modules exists (for AI environments)
# Post-commit hooks are less critical, so we'll try to run but skip if dependencies missing
if [ ! -d "node_modules" ]; then
  echo "âš ï¸  node_modules not found. Skipping post-commit automation."
  echo "   Run 'npm install' to enable post-commit tasks."
  exit 0
fi

# Update framework metrics (if script exists)
if [ -f "scripts/framework-metrics.js" ]; then
  echo "ğŸ“ˆ Updating framework metrics..."
  node scripts/framework-metrics.js >/dev/null 2>&1 || true
fi

# Check for missing agent context files (optional - can be disabled)
if [ "$SKIP_POST_COMMIT" != "true" ] && [ "$SKIP_CONTEXT_CHECK" != "true" ]; then
  echo "ğŸ” Checking for missing agent context files..."
  node scripts/generate-missing-agent-contexts.mjs --dry-run >/dev/null 2>&1 || true
fi

# Update context verified status (when context files changed)
if [ "$SKIP_POST_COMMIT" != "true" ] && git diff HEAD~1 --name-only | grep -q "\.agent-context\.\(json\|toon\)"; then
  echo "âœ… Updating context verified status..."
  node scripts/update-context-verified.js >/dev/null 2>&1 || true
fi

# Generate commit summary (optional - can be disabled)
if [ "$SKIP_POST_COMMIT" != "true" ]; then
  echo "ğŸ“ Commit completed successfully!"
  echo "   Run 'npm run index:watch' to auto-update indexes during development"
  echo "   Run 'npm run constitution:watch' to auto-compile constitution during development"
  echo "   Run 'npm run context:generate' to generate missing .agent-context.toon files"
fi
