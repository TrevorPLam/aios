# Server Directory Instructions

**Path:** `/server`
**Purpose:** Express.js backend API with PostgreSQL
**Agent Role:** Primary (GitHub Copilot)

---

## Quick Reference

### Before making changes, read
- [BESTPR.md](../BESTPR.md) - Token-optimized best practices guide
- [Constitution](../docs/governance/constitution.md) - Core laws and governance
- [Server Laws](.github/instructions/server.instructions.md) - Backend-specific rules

---

## Directory Structure

```text
server/
├── index.ts          # Express app entry point
├── routes.ts         # 42+ API endpoints
├── storage.ts        # Database operations (Drizzle ORM)
├── middleware/
│   ├── auth.ts       # JWT verification
│   ├── errorHandler.ts
│   └── validation.ts # Zod validation
├── utils/
│   └── logger.ts     # Winston structured logging
└── templates/        # Email/message templates
```text

---

## Key Patterns

### 1. Always Validate Inputs with Zod
```typescript
// ✅ DO: Validate ALL inputs
import { z } from 'zod'

const loginSchema = z.object({
  username: z.string().min(3),
  password: z.string().min(8)
})

app.post('/api/login', async (req, res) => {
  const result = loginSchema.safeParse(req.body)
  if (!result.success) {
    return res.status(400).json({ error: result.error })
  }
  // ...
})

// ❌ DON'T: Trust inputs
const { username, password } = req.body // Unsafe!
```text

### 2. Use JWT for Authentication
```typescript
// server/middleware/auth.ts
// JWT with 7-day expiry, bcryptjs hashing
// Always validate token on protected routes

app.get('/api/protected', authenticateToken, (req, res) => {
  // req.user populated by middleware
})
```text

### 3. Structured Logging (JSON)
```typescript
// ✅ DO: Structured logs with context
import { logger } from './utils/logger'

logger.info('User login', {
  userId: user.id,
  username: user.username,
  timestamp: new Date().toISOString()
})

// ❌ DON'T: Log secrets
logger.info('Token:', token) // NO! Use [REDACTED]
```text

### 4. Database Transactions
```typescript
// ✅ DO: Use transactions for multi-step operations
import { db } from './storage'

await db.transaction(async (tx) => {
  await tx.insert(users).values(userData)
  await tx.insert(profiles).values(profileData)
})
```text

### 5. Error Handling
```typescript
// ✅ DO: Use error middleware
app.use(errorHandler)

// ✅ DO: Return structured errors
res.status(400).json({
  error: 'Validation failed',
  details: validationErrors
})
```text

---

## Common Files

| File | Purpose |
| ------ | --------- |
| `routes.ts` | All Express route definitions (42+ endpoints) |
| `storage.ts` | Database operations with Drizzle ORM |
| `middleware/auth.ts` | JWT authentication |
| `middleware/validation.ts` | Zod input validation |
| `utils/logger.ts` | Winston structured logging |

---

## Critical Rules

1. **Input Validation:** ALL inputs validated with Zod (zero exceptions)
2. **Authentication:** JWT on protected routes
3. **Database:** Use transactions for multi-step operations
4. **Logging:** Structured logs (JSON), never log secrets
5. **Error Handling:** Return structured errors with details
6. **API Contract:** Define in OpenAPI before implementing
7. **Type Safety:** TypeScript strict mode

---

## Security Checklist

- [ ] All inputs validated with Zod schemas
- [ ] JWT authentication on protected endpoints
- [ ] Passwords hashed with bcryptjs
- [ ] CORS configured properly
- [ ] Secrets in environment variables (never in code)
- [ ] No secrets in logs (use `[REDACTED]`)
- [ ] SQL injection prevented (Drizzle parameterization)
- [ ] Authorization checks on every endpoint

---

## Database Operations

```typescript
// ✅ DO: Use Drizzle ORM
import { db } from './storage'
import { users } from '../shared/schema'

// Insert
await db.insert(users).values({ username, password })

// Select
const user = await db.query.users.findFirst({
  where: eq(users.username, username)
})

// Update
await db.update(users)
  .set({ lastLogin: new Date() })
  .where(eq(users.id, userId))

// Delete
await db.delete(users).where(eq(users.id, userId))
```text

---

## Before Committing

- [ ] Read [BESTPR.md](../BESTPR.md)
- [ ] All inputs validated with Zod
- [ ] JWT auth on protected routes
- [ ] Structured logging (no secrets)
- [ ] Database transactions where needed
- [ ] TypeScript strict mode passes
- [ ] Tests written and passing
- [ ] OpenAPI spec updated (if API changes)
- [ ] No secrets in code or logs

---

### See [BESTPR.md](../BESTPR.md) for comprehensive best practices