name: Constitution Sync Check

on:
  pull_request:
    paths:
      - 'docs/governance/constitution.md'
      - '.github/copilot-instructions.md'
      - '.github/instructions/*.md'
      - 'scripts/tools/compile-constitution.mjs'
  workflow_dispatch:

jobs:
  check-constitution-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Run constitution compiler
        run: node scripts/tools/compile-constitution.mjs
        
      - name: Check for drift
        run: |
          if git diff --exit-code .github/copilot-instructions.md .github/instructions/; then
            echo "‚úÖ Copilot instructions are in sync with constitution"
          else
            echo "‚ùå Copilot instructions are out of sync with constitution!"
            echo ""
            echo "üìù Changes needed:"
            git diff .github/copilot-instructions.md .github/instructions/
            echo ""
            echo "üîß To fix:"
            echo "   1. Run: npm run compile:constitution"
            echo "   2. Commit the generated files"
            echo "   3. Push changes"
            exit 1
          fi
          
      - name: Verify constitution tags
        run: |
          echo "üîç Checking for required COPILOT: tags in constitution..."
          
          if ! grep -q "## COPILOT:GLOBAL" docs/governance/constitution.md; then
            echo "‚ùå Missing ## COPILOT:GLOBAL tag"
            exit 1
          fi
          
          if ! grep -q "## COPILOT:DOCS" docs/governance/constitution.md; then
            echo "‚ùå Missing ## COPILOT:DOCS tag"
            exit 1
          fi
          
          if ! grep -q "## COPILOT:CLIENT" docs/governance/constitution.md; then
            echo "‚ùå Missing ## COPILOT:CLIENT tag"
            exit 1
          fi
          
          if ! grep -q "## COPILOT:SERVER" docs/governance/constitution.md; then
            echo "‚ùå Missing ## COPILOT:SERVER tag"
            exit 1
          fi
          
          echo "‚úÖ All required COPILOT: tags found"
