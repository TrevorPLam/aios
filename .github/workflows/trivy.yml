name: Trivy Security Scan

# Trivy catches security issues in dependencies and configuration.
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    # Daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-config-results.txt'
          exit-code: '0'

      - name: Generate human-readable report
        if: always()
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-report.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-reports-${{ github.sha }}
          path: |
            trivy-*.txt
            trivy-*.sarif
          retention-days: 30

      - name: Create security summary
        if: always()
        run: |
          echo "## ðŸ”’ Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-config-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for critical vulnerabilities
        id: check-critical
        run: |
          if grep -q "CRITICAL" trivy-report.txt; then
            echo "critical=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ CRITICAL vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "critical=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for critical vulnerabilities (scheduled)
        if: steps.check-critical.outputs.critical == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('trivy-report.txt', 'utf8');

            const body = `## ðŸš¨ Critical Security Vulnerabilities Detected

            The daily Trivy scan has found **CRITICAL** vulnerabilities.

            ### Summary

            Please review and address these vulnerabilities immediately.

            ### Detailed Report

            \`\`\`
            ${report}
            \`\`\`

            ### Next Steps

            1. Review the vulnerabilities above
            2. Update affected dependencies
            3. Test the updates thoroughly
            4. Deploy the fixes

            ---
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Scan Date:** ${new Date().toISOString()}`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Critical Security Vulnerabilities Found by Trivy',
              body: body,
              labels: ['security', 'critical', 'trivy']
            });

  trivy-npm:
    name: Trivy NPM Dependencies Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Trivy on node_modules
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'node_modules'
          format: 'json'
          output: 'trivy-npm.json'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload NPM scan results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-npm-${{ github.sha }}
          path: trivy-npm.json
          retention-days: 30
