name: OpenSSF Scorecard

# OpenSSF Scorecard measures security best practices compliance.
on:
  push:
    branches:
      - main
  schedule:
    # Weekly on Wednesdays at 10 AM UTC
    - cron: '0 10 * * 3'
  workflow_dispatch:

permissions: read-all

jobs:
  scorecard:
    name: Run OpenSSF Scorecard Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@v2
        with:
          results_file: results.sarif
          results_format: sarif
          # Publish results to OpenSSF REST API for public repositories
          publish_results: ${{ github.repository_owner == 'yourusername' && github.event_name != 'pull_request' }}

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

      - name: Generate human-readable report
        run: |
          # Convert SARIF to JSON for parsing
          echo "## ðŸ”’ OpenSSF Scorecard Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The scorecard evaluates security best practices across multiple dimensions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Areas Evaluated" >> $GITHUB_STEP_SUMMARY
          echo "- **Binary Artifacts**: Checks for checked-in binaries" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch Protection**: Verifies branch protection rules" >> $GITHUB_STEP_SUMMARY
          echo "- **CI Tests**: Validates automated testing" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Review**: Checks for peer review practices" >> $GITHUB_STEP_SUMMARY
          echo "- **Dangerous Workflow**: Scans for risky GitHub Actions patterns" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Update Tool**: Checks for automated dependency updates" >> $GITHUB_STEP_SUMMARY
          echo "- **Fuzzing**: Looks for fuzz testing" >> $GITHUB_STEP_SUMMARY
          echo "- **License**: Verifies project has a license" >> $GITHUB_STEP_SUMMARY
          echo "- **Maintained**: Checks if project is actively maintained" >> $GITHUB_STEP_SUMMARY
          echo "- **Pinned Dependencies**: Verifies dependencies are pinned" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST**: Checks for static analysis security testing" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Policy**: Looks for SECURITY.md" >> $GITHUB_STEP_SUMMARY
          echo "- **Signed Releases**: Checks for cryptographically signed releases" >> $GITHUB_STEP_SUMMARY
          echo "- **Token Permissions**: Validates GitHub token permissions" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilities**: Checks for known security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **View detailed results in Security > Code scanning alerts**" >> $GITHUB_STEP_SUMMARY

      - name: Upload scorecard results
        uses: actions/upload-artifact@v6
        with:
          name: scorecard-results-${{ github.sha }}
          path: results.sarif
          retention-days: 90

  badge:
    name: Update Scorecard Badge
    runs-on: ubuntu-latest
    needs: scorecard
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with badge
        run: |
          # Check if README has scorecard badge, if not add it
          if ! grep -q "ossf-scorecard" README.md; then
            echo "Adding OpenSSF Scorecard badge to README.md"
            sed -i '1i[![OpenSSF Scorecard](https://api.securityscorecards.dev/projects/github.com/${{ github.repository }}/badge)](https://securityscorecards.dev/viewer/?uri=github.com/${{ github.repository }})\n' README.md

            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add README.md
            git diff --staged --quiet || git commit -m "docs: add OpenSSF Scorecard badge [skip ci]"
            git push
          else
            echo "Scorecard badge already exists in README.md"
          fi
        continue-on-error: true
