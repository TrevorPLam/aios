name: Intelligent Automation

on:
  pull_request:
    types: [opened, synchronize, closed]
  push:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  task-completion-detection:
    name: Auto-Detect Task Completion
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Detect completed tasks
        run: |
          npm run intelligent:task-completion -- --commit ${{ github.event.pull_request.merge_commit_sha }}
        continue-on-error: true
      
      - name: Commit task updates
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .repo/tasks/
          git commit -m "chore: auto-archive completed tasks [skip ci]" || exit 0
          git push || exit 0

  task-dependency-resolution:
    name: Auto-Resolve Task Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed')
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Resolve task dependencies
        run: |
          npm run intelligent:task-dependencies
        continue-on-error: true
      
      - name: Commit task promotions
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .repo/tasks/
          git commit -m "chore: auto-promote tasks with resolved dependencies [skip ci]" || exit 0
          git push || exit 0

  auto-generate-pr-description:
    name: Auto-Generate PR Description
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate PR description
        id: generate-pr
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          node scripts/intelligent/auto-generate-pr-description.mjs --base-ref "$BASE_REF" --output-file /tmp/pr-description.md
          echo "description<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/pr-description.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment PR description
        uses: actions/github-script@v7
        with:
          script: |
            const description = `${{ steps.generate-pr.outputs.description }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ü§ñ Auto-Generated PR Description\n\n${description}\n\n---\n\n*This description was auto-generated. Please review and update as needed.*`
            });

  todo-to-task-conversion:
    name: Convert TODOs to Tasks
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
      
      - name: Convert TODOs to tasks
        run: |
          npm run intelligent:todos-to-tasks -- --scan-all
        continue-on-error: true
      
      - name: Commit new tasks
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .repo/tasks/
          git commit -m "chore: auto-convert TODOs to tasks [skip ci]" || exit 0
          git push || exit 0

  adr-generation:
    name: Auto-Generate ADR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for ADR triggers
        id: adr-check
        run: |
          node scripts/intelligent/intelligent-adr-generator.mjs || EXIT_CODE=$?
          if [ "${EXIT_CODE:-0}" = "0" ]; then
            echo "adr_needed=false" >> $GITHUB_OUTPUT
          else
            echo "adr_needed=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Comment ADR reminder
        if: steps.adr-check.outputs.adr_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìã ADR Required\n\nThis PR appears to trigger ADR requirements (cross-module imports, API changes, or schema changes).\n\nPlease create an ADR using:\n\`\`\`bash\nnpm run intelligent:adr\n\`\`\`\n\nOr manually create one following the template in \`.repo/templates/ADR_TEMPLATE.md\``
            });

  breaking-change-detection:
    name: Breaking Change Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Detect breaking changes
        id: breaking-changes
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref || 'main' }}"
          node scripts/intelligent/intelligent-breaking-change-detector.mjs --base-ref "$BASE_REF" --output migration-guide.md || EXIT_CODE=$?
          echo "has_breaking=${EXIT_CODE:-0}" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload migration guide
        if: steps.breaking-changes.outputs.has_breaking == '1'
        uses: actions/upload-artifact@v4
        with:
          name: migration-guide
          path: migration-guide.md
      
      - name: Comment breaking changes
        if: steps.breaking-changes.outputs.has_breaking == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const guide = fs.readFileSync('migration-guide.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Breaking Changes Detected\n\n${guide}`
            });

  bundle-optimization:
    name: Bundle Size Optimization
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check bundle size
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref || 'main' }}"
          npm run intelligent:bundle-optimize -- --base-ref "$BASE_REF"
        continue-on-error: true

  performance-regression:
    name: Performance Regression Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Detect performance regressions
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref || 'main' }}"
          npm run intelligent:performance -- --base-ref "$BASE_REF"
        continue-on-error: true

  code-similarity:
    name: Code Similarity Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Detect code similarity
        run: |
          npm run intelligent:similarity -- --suggest-fixes
        continue-on-error: true
