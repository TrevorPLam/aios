# Shared Directory Instructions

**Path:** `/shared`  
**Purpose:** Shared code between client and server  
**Agent Role:** Primary (GitHub Copilot)

---

## Quick Reference

**Before making changes, read:**
- [BESTPR.md](../BESTPR.md) - Token-optimized best practices guide
- [Constitution](../docs/governance/constitution.md) - Core laws and governance

---

## Directory Structure

```
shared/
├── schema.ts         # Drizzle database schemas (all tables)
└── constants.ts      # Shared constants
```

---

## Key Patterns

### 1. Database Schema (Drizzle)
```typescript
// shared/schema.ts
import { pgTable, uuid, varchar, timestamp } from 'drizzle-orm/pg-core'

export const users = pgTable('users', {
  id: uuid('id').defaultRandom().primaryKey(),
  username: varchar('username', { length: 50 }).notNull().unique(),
  password: varchar('password', { length: 255 }).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull()
})

// ✅ DO: Use UUIDs for primary keys
// ✅ DO: Add timestamps (createdAt, updatedAt)
// ✅ DO: Validate constraints (.notNull(), .unique())
```

### 2. Zod Integration
```typescript
// ✅ DO: Generate Zod schemas from Drizzle schemas
import { createInsertSchema, createSelectSchema } from 'drizzle-zod'

export const insertUserSchema = createInsertSchema(users, {
  username: (schema) => schema.min(3).max(50),
  password: (schema) => schema.min(8)
})

export const selectUserSchema = createSelectSchema(users)
```

### 3. Shared Constants
```typescript
// shared/constants.ts
export const API_VERSION = 'v1'
export const JWT_EXPIRY = '7d'
export const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB
```

---

## Critical Rules

1. **Database Schemas:** All tables defined in `schema.ts`
2. **UUIDs:** Use UUIDs for primary keys (not sequential IDs)
3. **Timestamps:** Include createdAt, updatedAt where applicable
4. **Validation:** Generate Zod schemas from Drizzle schemas
5. **Migrations:** Never modify existing migrations, create new ones
6. **Type Safety:** Full TypeScript strict mode

---

## Schema Checklist

When adding new tables:

- [ ] Use UUID for primary key
- [ ] Add createdAt timestamp
- [ ] Add updatedAt timestamp (if mutable)
- [ ] Define foreign keys with `.references()`
- [ ] Add constraints (.notNull(), .unique())
- [ ] Generate Zod schemas for validation
- [ ] Test migration: `npm run db:push`
- [ ] Update type exports

---

## Database Migration Workflow

```bash
# 1. Edit schema.ts (add new table or column)
# 2. Generate migration
npm run db:push

# 3. Verify migration applied
# Check PostgreSQL database

# ❌ DON'T: Modify existing migrations
# ✅ DO: Create new migration for changes
```

---

## Common Tables

| Table | Purpose | Key Columns |
|-------|---------|-------------|
| `users` | User accounts | id, username, password |
| `recommendations` | AI recommendations | id, userId, module, title |
| `notes` | Notebook entries | id, userId, title, bodyMarkdown |
| `tasks` | Planner tasks | id, userId, title, dueDate |
| `projects` | Task projects | id, userId, name, parentTaskId |
| `events` | Calendar events | id, userId, title, startTime |
| `contacts` | Contact entries | id, userId, name, email |
| `messages` | Messages | id, userId, content, threadId |

---

## Before Committing

- [ ] Read [BESTPR.md](../BESTPR.md)
- [ ] Database schema valid (UUIDs, timestamps, constraints)
- [ ] Zod schemas generated
- [ ] Migration tested: `npm run db:push`
- [ ] TypeScript strict mode passes
- [ ] No breaking changes to existing schemas
- [ ] Documentation updated

---

**See [BESTPR.md](../BESTPR.md) for comprehensive best practices.**
